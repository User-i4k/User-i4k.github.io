<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>xQuera - Oda</title>
  <link rel="stylesheet" href="style.css">
  <script type="module" src="firebase.js"></script>
</head>
<body>
  
  <script src="guard.js"></script>
  
  <header>
    <button class="ghost" onclick="window.location.href='home.html'">üè† Ana Sayfa</button>
    <h1 id="roomName">Oda</h1>
    <div class="userbar"><span id="playerName"></span></div>
  </header>

  <!-- Games panel (only visible in game rooms) -->
  <section id="games" class="games hidden">
    <div class="cards">
      <div class="game-card" id="card-ttt">‚ùå‚≠ï Tic-Tac-Toe</div>
      <div class="game-card" id="card-dice">üé≤ Zar Atma</div>
    </div>
    <div id="gameArea" class="game-area hidden"></div>
  </section>

  <main class="chat-box" id="chatBox"></main>

  <footer class="chat-input">
    <input id="msgInput" type="text" placeholder="Mesaj yaz...">
    <button id="sendBtn">G√∂nder</button>
  </footer>

  <script type="module">
    import { db, ref, push, set, onValue, remove, onDisconnect, get, child } from "./firebase.js";

    const params = new URLSearchParams(window.location.search);
    const type = params.get("type");
    const username = localStorage.getItem("username");
    const room = localStorage.getItem("room");
    if(!username || !room || !type) window.location.href = "home.html";

    document.getElementById("roomName").innerText = room;
    document.getElementById("playerName").textContent = `üë§ ${username}`;

    const roomPath = `rooms/${type}/${room}`;
    const chatRef = ref(db, `${roomPath}/messages`);
    const userRef = ref(db, `${roomPath}/users/${username}`);
    const gameRootRef = ref(db, `${roomPath}/game`);
    const tttRef = ref(db, `${roomPath}/game/ttt`);
    const diceRef = ref(db, `${roomPath}/game/dice/last`);

    // Kullanƒ±cƒ± giri≈ü yaptƒ±ƒüƒ±nda odaya ekle ve baƒülantƒ± kesildiƒüinde √ßƒ±kar
    set(userRef, true);
    try { onDisconnect(userRef).remove(); } catch (_) {}

    // Kullanƒ±cƒ± sayƒ±sƒ±nƒ± takip et
    onValue(ref(db, `${roomPath}/users`), snap => {
      const count = snap.exists() ? Object.keys(snap.val()).length : 0;
      document.title = `${room} (${count} ki≈üi)`;
    });

    // Mesajlarƒ± g√∂ster
    onValue(chatRef, snap => {
      const box = document.getElementById("chatBox");
      box.innerHTML = "";
      snap.forEach(msg => {
        const m = msg.val();
        const div = document.createElement("div");
        div.className = "msg";
        div.innerHTML = `<strong>${m.user}</strong>: ${m.text}`;
        box.appendChild(div);
      });
      box.scrollTop = box.scrollHeight;
    });

    // Mesaj g√∂nder
    const inputEl = document.getElementById("msgInput");
    const send = () => {
      const text = inputEl.value.trim();
      if(!text) return;
      push(chatRef, { user: username, text });
      inputEl.value = "";
    };
    document.getElementById("sendBtn").addEventListener("click", send);
    inputEl.addEventListener("keydown", (e) => { if (e.key === "Enter") send(); });

    // √áƒ±kƒ±≈üta kullanƒ±cƒ±yƒ± odadan sil
    window.addEventListener("beforeunload", () => remove(userRef));

    // Oyunlar: sadece type === 'game' ise g√∂ster
    const gamesSection = document.getElementById('games');
    const gameArea = document.getElementById('gameArea');
    let tttSubscribed = false;
    let diceSubscribed = false;

    if (type === 'game') {
      gamesSection.classList.remove('hidden');
      document.getElementById('card-ttt').addEventListener('click', openTTT);
      document.getElementById('card-dice').addEventListener('click', openDice);
    }

    function showGameArea() {
      gameArea.classList.remove('hidden');
      // Scroll chat below games into view
      try { document.getElementById('chatBox').scrollTop = 0; } catch (_) {}
    }

    // Tic-Tac-Toe
    async function ensureTTT() {
      const snap = await get(tttRef);
      if (!snap.exists()) {
        await set(tttRef, { board: Array(9).fill(''), turn: 'X', winner: '' });
      }
    }

    function renderTTT(state) {
      const winnerText = state.winner ? (state.winner === 'draw' ? 'Berabere!' : `Kazanan: ${state.winner}`) : `Sƒ±ra: ${state.turn}`;
      gameArea.innerHTML = `
        <h3>‚ùå‚≠ï Tic-Tac-Toe</h3>
        <p id="tttStatus">${winnerText}</p>
        <div class="ttt-grid">
          ${state.board.map((v, i) => `<button class="ttt-cell" data-i="${i}" ${v || state.winner ? 'disabled' : ''}>${v || ''}</button>`).join('')}
        </div>
        <div style="margin-top:12px; display:flex; gap:10px;">
          <button id="tttReset">Sƒ±fƒ±rla</button>
        </div>
      `;
      gameArea.querySelectorAll('.ttt-cell').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const i = Number(e.currentTarget.getAttribute('data-i'));
          const latest = (await get(tttRef)).val();
          if (!latest || latest.winner || latest.board[i]) return;
          const nextBoard = latest.board.slice();
          nextBoard[i] = latest.turn;
          const nextWinner = checkWinner(nextBoard);
          const nextTurn = nextWinner ? latest.turn : (latest.turn === 'X' ? 'O' : 'X');
          await set(tttRef, { board: nextBoard, turn: nextTurn, winner: nextWinner || '' });
        });
      });
      document.getElementById('tttReset').addEventListener('click', async () => {
        await set(tttRef, { board: Array(9).fill(''), turn: 'X', winner: '' });
      });
      showGameArea();
    }

    function checkWinner(b) {
      const lines = [
        [0,1,2],[3,4,5],[6,7,8],
        [0,3,6],[1,4,7],[2,5,8],
        [0,4,8],[2,4,6]
      ];
      for (const [a,b1,c] of lines) {
        if (b[a] && b[a] === b[b1] && b[a] === b[c]) return b[a];
      }
      if (b.every(x => x)) return 'draw';
      return '';
    }

    async function openTTT() {
      await ensureTTT();
      if (!tttSubscribed) {
        onValue(tttRef, (snap) => {
          const state = snap.exists() ? snap.val() : { board: Array(9).fill(''), turn: 'X', winner: '' };
          renderTTT(state);
        });
        tttSubscribed = true;
      } else {
        const state = (await get(tttRef)).val() || { board: Array(9).fill(''), turn: 'X', winner: '' };
        renderTTT(state);
      }
    }

    // Dice
    function renderDice(last) {
      const lastText = last?.value ? `${last.value} ${last.by ? '(' + last.by + ')' : ''}` : '-';
      gameArea.innerHTML = `
        <h3>üé≤ Zar Atma</h3>
        <p>Son sonu√ß: <strong id="diceLast">${lastText}</strong></p>
        <div style="margin-top:12px; display:flex; gap:10px;">
          <button id="diceRoll">Zar At</button>
        </div>
      `;
      document.getElementById('diceRoll').addEventListener('click', async () => {
        const roll = Math.floor(Math.random() * 6) + 1;
        await set(diceRef, { value: roll, by: username, at: Date.now() });
        try { push(chatRef, { user: 'Sistem', text: `üé≤ ${username} zar attƒ±: ${roll}` }); } catch (_) {}
      });
      showGameArea();
    }

    async function openDice() {
      if (!diceSubscribed) {
        onValue(diceRef, (snap) => {
          renderDice(snap.exists() ? snap.val() : null);
        });
        diceSubscribed = true;
      } else {
        const last = (await get(diceRef)).val();
        renderDice(last);
      }
    }
  </script>
</body>
</html>
