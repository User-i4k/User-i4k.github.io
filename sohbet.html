<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Sohbet</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }

    #messages {
      height: 300px;
      border: 1px solid #ccc;
      padding: 10px;
      overflow-y: scroll;
      margin-bottom: 10px;
    }

    input[type="text"] {
      width: 70%;
      padding: 10px;
    }

    button {
      padding: 10px;
    }
  </style>
</head>
<body>
  <h2 id="odaAdi"></h2>
  <div id="messages"></div>
  <input type="text" id="msgInput" placeholder="Mesaj yaz..." />
  <button id="gonderBtn">Gönder</button>

  <!-- Firebase + Chat Script -->
  <script type="module">
    import { db } from './app.js';
    import { ref, onValue, push } from 'https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js';

    const oda = new URLSearchParams(window.location.search).get('oda');
    const kullanici = localStorage.getItem('username');

    if (!oda || !kullanici) {
      alert("Geçersiz giriş.");
      window.location.href = "index.html";
    }

    document.getElementById("odaAdi").innerText = `🗨️ ${oda} Odası`;

    const mesajRef = ref(db, `messages/${oda}`);
    const mesajKutusu = document.getElementById("messages");

    // Mesajları dinle ve ekrana yaz
    onValue(mesajRef, (snapshot) => {
      mesajKutusu.innerHTML = "";
      const veriler = snapshot.val();
      if (veriler) {
        Object.values(veriler).forEach(msg => {
          const div = document.createElement("div");
          div.textContent = `${msg.user}: ${msg.text}`;
          mesajKutusu.appendChild(div);
        });
        mesajKutusu.scrollTop = mesajKutusu.scrollHeight;
      }
    });

    // Mesaj gönder
    document.getElementById("gonderBtn").onclick = () => {
      const mesaj = document.getElementById("msgInput").value.trim();
      if (!mesaj) return;

      push(mesajRef, {
        user: kullanici,
        text: mesaj
      });

      document.getElementById("msgInput").value = "";
    };
  </script>
</body>
</html>
